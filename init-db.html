<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialize Database | Nudge Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
        }

        .card {
            background: #1e293b;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid #334155;
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: #dc2626;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #334155;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background: #0f172a;
            color: #fff;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #334155;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .log {
            background: #0f172a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid #1e293b;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.success {
            color: #22c55e;
        }

        .log-entry.error {
            color: #ef4444;
        }

        .log-entry.warning {
            color: #f59e0b;
        }

        .log-entry.info {
            color: #3b82f6;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.demo {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.live {
            background: #dcfce7;
            color: #166534;
        }

        .note {
            background: #1e293b;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            border-radius: 0 10px 10px 0;
            margin: 16px 0;
        }

        .note p {
            color: #fcd34d;
            font-size: 0.9rem;
        }

        .divider {
            height: 1px;
            background: #334155;
            margin: 24px 0;
        }

        .checklist {
            list-style: none;
        }

        .checklist li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
        }

        .checklist li::before {
            content: '‚óã';
            color: #64748b;
        }

        .checklist li.done::before {
            content: '‚úì';
            color: #22c55e;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 24px 16px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .card {
                padding: 20px;
            }

            .card h2 {
                font-size: 1.1rem;
            }

            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.85rem;
            }

            .form-group label {
                font-size: 0.9rem;
            }

            .form-group input {
                font-size: 16px;
                /* Prevents auto-zoom on iOS */
                padding: 12px 14px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 14px 24px;
            }

            .log {
                font-size: 0.75rem;
                max-height: 200px;
                padding: 16px;
            }

            .note {
                padding: 12px;
            }

            .note p {
                font-size: 0.85rem;
            }

            .checklist li {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 16px 12px;
            }

            .container {
                max-width: 100%;
            }

            .header h1 {
                font-size: 1.35rem;
            }

            .card {
                padding: 16px;
                border-radius: 12px;
            }

            .card h2 {
                font-size: 1rem;
            }

            .step-number {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .log {
                font-size: 0.7rem;
                max-height: 150px;
                padding: 12px;
            }

            .log-entry {
                padding: 4px 0;
            }

            .status-badge {
                font-size: 0.8rem;
                padding: 4px 10px;
            }
        }

        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .card h2 {
                font-size: 0.95rem;
            }

            .form-group input {
                font-size: 16px;
                padding: 10px 12px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîß Database Initialization</h1>
            <p>Set up Firestore collections for Nudge Academy</p>
            <div style="margin-top: 16px;">
                <span id="modeStatus" class="status-badge demo">‚ö†Ô∏è Demo Mode</span>
            </div>
        </div>

        <!-- Step 1: Create Admin User in Firebase Auth -->
        <div class="card">
            <h2><span class="step-number">1</span> Create Admin User</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                First, create a user account that will become the admin. This user must exist in Firebase
                Authentication.
            </p>

            <div class="form-group">
                <label>Admin Email</label>
                <input type="email" id="adminEmail" placeholder="admin@nudgeacademy.com" value="admin@nudge.com">
            </div>
            <div class="form-group">
                <label>Admin Password</label>
                <input type="password" id="adminPassword" placeholder="Strong password" value="admin123">
            </div>
            <div class="form-group">
                <label>Admin Name</label>
                <input type="text" id="adminName" placeholder="Super Admin" value="Super Admin">
            </div>

            <div class="note">
                <p>‚ö†Ô∏è If using production Firebase, this will create a real user account. Change the password after
                    setup!</p>
            </div>

            <button class="btn btn-primary" onclick="createAdminUser()" id="btnCreateUser">
                Create Admin User
            </button>
        </div>

        <!-- Step 2: Add to Admins Collection -->
        <div class="card">
            <h2><span class="step-number">2</span> Initialize Collections</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                This will add the admin user to the 'admins' collection and create a sample test.
            </p>

            <button class="btn btn-primary" onclick="initializeDatabase()" id="btnInit" disabled>
                Initialize Database
            </button>
        </div>

        <!-- Step 3: Verify Setup -->
        <div class="card">
            <h2><span class="step-number">3</span> Verification</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">Checklist of what should be set up:</p>

            <ul class="checklist" id="checklist">
                <li id="checkFirebase">Firebase initialized</li>
                <li id="checkAuth">Admin user created in Auth</li>
                <li id="checkAdmins">Admin added to 'admins' collection</li>
                <li id="checkTests">Sample test created in 'tests' collection</li>
                <li id="checkFolders">Sample folder created</li>
            </ul>

            <div class="divider"></div>

            <button class="btn btn-secondary" onclick="window.location.href='admin_login.html'">
                Go to Admin Login ‚Üí
            </button>
        </div>

        <!-- Log Output -->
        <div class="card">
            <h2>üìã Log Output</h2>
            <div class="log" id="log">
                <div class="log-entry info">Waiting for action...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        let adminUid = null;

        // Update mode status
        function updateModeStatus() {
            const status = document.getElementById('modeStatus');
            if (isDemoMode) {
                status.className = 'status-badge demo';
                status.innerHTML = '‚ö†Ô∏è Demo Mode';
            } else {
                status.className = 'status-badge live';
                status.innerHTML = '‚úì Firebase Connected';
                markCheck('checkFirebase');
            }
        }
        updateModeStatus();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function markCheck(id) {
            document.getElementById(id).classList.add('done');
        }

        async function createAdminUser() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const name = document.getElementById('adminName').value;

            if (!email || !password || !name) {
                log('Please fill in all fields', 'error');
                return;
            }

            const btn = document.getElementById('btnCreateUser');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                if (isDemoMode) {
                    log('Demo mode: Simulating user creation', 'warning');
                    adminUid = 'demo_admin_' + Date.now();
                    log(`Admin user created (demo): ${email}`, 'success');
                    markCheck('checkAuth');
                    document.getElementById('btnInit').disabled = false;
                } else {
                    // Create user in Firebase Auth
                    log('Creating user in Firebase Auth...');

                    try {
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        adminUid = userCredential.user.uid;

                        // Update profile with name
                        await userCredential.user.updateProfile({ displayName: name });

                        log(`‚úÖ User created with UID: ${adminUid}`, 'success');
                        markCheck('checkAuth');
                        document.getElementById('btnInit').disabled = false;
                    } catch (authError) {
                        if (authError.code === 'auth/email-already-in-use') {
                            log('User already exists. Signing in...', 'warning');

                            // Try to sign in instead
                            const signInResult = await firebase.auth().signInWithEmailAndPassword(email, password);
                            adminUid = signInResult.user.uid;
                            log(`‚úÖ Signed in existing user: ${adminUid}`, 'success');
                            markCheck('checkAuth');
                            document.getElementById('btnInit').disabled = false;
                        } else {
                            throw authError;
                        }
                    }
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                if (error.code === 'auth/weak-password') {
                    log('Password should be at least 6 characters', 'warning');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Admin User';
            }
        }

        async function initializeDatabase() {
            if (!adminUid) {
                log('Please create admin user first', 'error');
                return;
            }

            const email = document.getElementById('adminEmail').value;
            const name = document.getElementById('adminName').value;

            const btn = document.getElementById('btnInit');
            btn.disabled = true;
            btn.textContent = 'Initializing...';

            try {
                if (isDemoMode) {
                    log('Demo mode: Simulating database initialization', 'warning');

                    // Demo: Save to localStorage
                    localStorage.setItem('nudge_demo_admin', JSON.stringify({
                        email, name, role: 'admin', uid: adminUid
                    }));

                    markCheck('checkAdmins');
                    markCheck('checkTests');
                    markCheck('checkFolders');

                    log('‚úÖ Demo database initialized!', 'success');
                } else {
                    const db = firebase.firestore();

                    // 1. Add to admins collection (using UID as document ID)
                    log('Adding user to admins collection...');
                    await db.collection('admins').doc(adminUid).set({
                        email: email,
                        name: name,
                        role: 'admin',
                        uid: adminUid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log('‚úÖ Admin added to collection', 'success');
                    markCheck('checkAdmins');

                    // 2. Create sample folder
                    log('Creating sample folder...');
                    const folderRef = await db.collection('folders').add({
                        name: 'CUET General Test',
                        price: 0,
                        icon: 'üìö',
                        description: 'Free practice tests for CUET preparation',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log(`‚úÖ Folder created: ${folderRef.id}`, 'success');
                    markCheck('checkFolders');

                    // 3. Create sample test with questions
                    log('Creating sample test with questions...');
                    const testData = {
                        title: 'CUET Sample Test 1',
                        type: 'General Test',
                        subjects: ['CUET General Test'],
                        questions: 5,
                        duration: 10,
                        marks: 20,
                        marksPerQuestion: 4,
                        negativeMarks: 1,
                        price: 0,
                        status: 'active',
                        description: 'A sample test to get started with CUET preparation.',
                        icon: 'üìù',
                        questionData: [
                            {
                                id: 'q1',
                                question: '<p>What is the full form of CUET?</p>',
                                options: [
                                    'Central University Entrance Test',
                                    'Common University Entrance Test',
                                    'Combined University Entrance Test',
                                    'Central Unified Entrance Test'
                                ],
                                correct: 1,
                                solution: '<p>CUET stands for Common University Entrance Test, conducted by NTA for admissions to Central Universities.</p>'
                            },
                            {
                                id: 'q2',
                                question: '<p>Which organization conducts CUET in India?</p>',
                                options: [
                                    'CBSE',
                                    'UGC',
                                    'NTA',
                                    'AICTE'
                                ],
                                correct: 2,
                                solution: '<p>The National Testing Agency (NTA) conducts CUET for admission to Central Universities.</p>'
                            },
                            {
                                id: 'q3',
                                question: '<p>How many sections are there in CUET UG?</p>',
                                options: [
                                    '2 Sections',
                                    '3 Sections',
                                    '4 Sections',
                                    '5 Sections'
                                ],
                                correct: 2,
                                solution: '<p>CUET UG has 4 sections: Section IA (Language), Section IB (Language), Section II (Domain), Section III (General Test).</p>'
                            },
                            {
                                id: 'q4',
                                question: '<p>What is the marking scheme for correct answers in CUET?</p>',
                                options: [
                                    '+2 marks',
                                    '+3 marks',
                                    '+4 marks',
                                    '+5 marks'
                                ],
                                correct: 3,
                                solution: '<p>In CUET, each correct answer carries +5 marks (as per latest pattern). Note: This may vary, always check official guidelines.</p>'
                            },
                            {
                                id: 'q5',
                                question: '<p>How many Central Universities accept CUET scores?</p>',
                                options: [
                                    'Less than 20',
                                    '20-40',
                                    '40-50',
                                    'More than 40'
                                ],
                                correct: 3,
                                solution: '<p>More than 40 Central Universities and many other institutions accept CUET scores for undergraduate admissions.</p>'
                            }
                        ],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: adminUid
                    };

                    await db.collection('tests').add(testData);
                    log('‚úÖ Sample test created with 5 questions', 'success');
                    markCheck('checkTests');

                    log('----------------------------------------', 'info');
                    log('üéâ Database initialization complete!', 'success');
                    log('You can now login at admin_login.html', 'success');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                if (error.code === 'permission-denied') {
                    log('HINT: Your Firestore Security Rules might be blocking writes.', 'warning');
                    log('Temporarily set rules to allow read/write, then update after setup.', 'warning');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Initialize Database';
            }
        }
    </script>
</body>

</html>